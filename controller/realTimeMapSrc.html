<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·åœ°å›¾è·¯å¾„è§„åˆ’ä¸å®šä½</title>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: "a645fab3d9396adafc4d4236665981fa",
        };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/loader.js"></script>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸åŸå§‹ä»£ç ç›¸åŒ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #2a4b8d);
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4b6cb7;
        }
        
        .panel h3 {
            margin-bottom: 10px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel h3 i {
            color: #4b6cb7;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            border-color: #4b6cb7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #4b6cb7, #3a5ca9);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        button.tertiary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .location-details p, .route-details p {
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        
        .location-details span, .route-details span {
            font-weight: 600;
            color: #4b6cb7;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 200;
            text-align: center;
        }
        
        .loading p {
            margin: 0;
            font-weight: 600;
            color: #4b6cb7;
        }
        
        .spinner {
            border: 4px solid rgba(75, 108, 183, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4b6cb7;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .result-item:hover {
            background-color: #e9ecef;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        #routePanel {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            background-color: white;
        }
        
        .click-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23e74c3c"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>') no-repeat center;
            background-size: contain;
            transform: translate(-50%, -100%);
            pointer-events: none;
            z-index: 201;
        }
        
        .map-tip {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 201;
            pointer-events: none;
        }
        
        .address-details {
            margin-top: 10px;
            padding: 10px;
            background: #f0f5ff;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .address-details p {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .poi-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 5px;
            background-color: white;
        }
        
        .poi-item {
            padding: 5px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
            cursor: pointer;
        }
        
        .poi-item:hover {
            background-color: #f0f5ff;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
                max-height: 40vh;
            }
            
            .map-container {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš— é«˜å¾·åœ°å›¾è·¯å¾„è§„åˆ’</h1>
        <p>è¾“å…¥èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œè·å–æœ€ä½³é©¾è½¦è·¯çº¿è§„åˆ’ | æ”¯æŒåœ°å›¾é€‰ç‚¹ã€é€†åœ°ç†ç¼–ç </p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="panel">
                <h3>ğŸ“ è·¯å¾„è§„åˆ’</h3>
                <div class="input-group">
                    <label for="citySelect">æœç´¢åŸå¸‚ï¼š</label>
                    <input type="text" id="citySelect" placeholder="è¾“å…¥åŸå¸‚" value="ç¦å·å¸‚">
                </div>
                
                <div class="input-group">
                    <label for="startPoint">èµ·ç‚¹ï¼š</label>
                    <input type="text" id="startPoint" placeholder="è¯·è¾“å…¥èµ·ç‚¹æˆ–ä½¿ç”¨å½“å‰ä½ç½®">
                </div>
                
                <div class="input-group">
                    <label for="endPoint">ç»ˆç‚¹ï¼š</label>
                    <input type="text" id="endPoint" placeholder="è¯·è¾“å…¥ç»ˆç‚¹åœ°å€" value="å¤©å®‰é—¨">
                </div>
                
                <div class="btn-group">
                    <button id="getLocation">
                        <i>ğŸ“</i> è·å–å½“å‰ä½ç½®
                    </button>
                    <button id="mapSelect" class="tertiary">
                        <i>ğŸ—ºğŸ—ºï¸</i> åœ°å›¾é€‰ç‚¹
                    </button>
                </div>
                
                <div class="btn-group">
                    <button id="routePlan">
                        <i>ğŸš€</i> å¼€å§‹è·¯å¾„è§„åˆ’
                    </button>
                    <button id="clearRoute" class="secondary">
                        <i>ğŸ—‘ï¸</i> æ¸…é™¤è·¯çº¿
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸŒ å½“å‰ä½ç½®ä¿¡æ¯</h3>
                <div class="location-details">
                    <p>ç»åº¦: <span id="currentLng">-</span></p>
                    <p>çº¬åº¦: <span id="currentLat">-</span></p>
                    <p>åœ°å€: <span id="currentAddress">æœªè·å–</span></p>
                    <p>åŸå¸‚: <span id="currentCity">-</span></p>
                </div>
                
                <div class="address-details" id="currentAddressDetails" style="display: none;">
                    <p>çœä»½: <span id="currentProvince">-</span></p>
                    <p>åŒºå¿: <span id="currentDistrict">-</span></p>
                    <p>ä¹¡é•‡: <span id="currentTownship">-</span></p>
                    <p>è¡—é“: <span id="currentStreet">-</span></p>
                    <p>é—¨ç‰Œ: <span id="currentNumber">-</span></p>
                </div>
                
                <div class="poi-list" id="currentNearbyPOI" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 5px;">é™„è¿‘åœ°ç‚¹:</div>
                    <!-- é™„è¿‘POIåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>

                <div class="btn-group">
                    <button id="setAsStart_now">
                        <i>â¡</i> è®¾ä¸ºèµ·ç‚¹
                    </button>
                    <button id="setAsEnd_now">
                        <i>ğŸ</i> è®¾ä¸ºç»ˆç‚¹
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ—ºğŸ—ºï¸ åœ°å›¾é€‰ç‚¹ç»“æœ</h3>
                <div class="location-details">
                    <p>ç»åº¦: <span id="clickLng">-</span></p>
                    <p>çº¬åº¦: <span id="clickLat">-</span></p>
                    <p>åœ°å€: <span id="clickAddress">æœªé€‰æ‹©</span></p>
                    <p>åŸå¸‚: <span id="clickCity">-</span></p>
                </div>
                
                <div class="address-details" id="clickAddressDetails" style="display: none;">
                    <p>çœä»½: <span id="clickProvince">-</span></p>
                    <p>åŒºå¿: <span id="clickDistrict">-</span></p>
                    <p>ä¹¡é•‡: <span id="clickTownship">-</span></p>
                    <p>è¡—é“: <span id="clickStreet">-</span></p>
                    <p>é—¨ç‰Œ: <span id="clickNumber">-</span></p>
                </div>
                
                <div class="poi-list" id="clickNearbyPOI" style="display: none;">
                    <div style="font-weight: bold; margin-bottom: 5px;">é™„è¿‘åœ°ç‚¹:</div>
                    <!-- é™„è¿‘POIåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="btn-group">
                    <button id="setAsStart">
                        <i>â¡</i> è®¾ä¸ºèµ·ç‚¹
                    </button>
                    <button id="setAsEnd">
                        <i>ğŸ</i> è®¾ä¸ºç»ˆç‚¹
                    </button>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ“Š è·¯å¾„ä¿¡æ¯</h3>
                <div class="route-details">
                    <p>è·ç¦»: <span id="routeDistance">-</span></p>
                    <p>æ—¶é—´: <span id="routeTime">-</span></p>
                    <p>çŠ¶æ€: <span id="routeInstructions">-</span></p>
                </div>
                <div id="routePanel">è·¯çº¿è¯¦æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-tip" id="mapTip">ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®</div>
            <div class="click-marker" id="clickMarker" style="display: none;"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åŠ è½½åœ°å›¾å’Œè·¯å¾„è§„åˆ’...</p>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let map = null;
        let geolocation = null;
        let geocoder = null;
        let driving = null;
        let placeSearch = null;
        let currentPosition = null;
        let clickMarker = null;
        let isMapSelectMode = false;
        let currentCity = "åŒ—äº¬";
        
        // æ–°å¢ï¼šä¿å­˜èµ·ç‚¹å’Œç»ˆç‚¹çš„ç²¾ç¡®åæ ‡å’Œæ˜¾ç¤ºåç§°
        let startPointData = {
            lnglat: null,
            address: null
        };
        let endPointData = {
            lnglat: null,
            address: null
        };
        
        // æ–°å¢ï¼šèµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
        let startMarker = null;
        let endMarker = null;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            showLoading();
            // ä½¿ç”¨AMapLoaderåŠ è½½åœ°å›¾
            AMapLoader.load({
                key: "4d0632a7126fcd25f89286bc3d33e0e7",
                version: "2.0",
                plugins: ['AMap.Geolocation', 'AMap.Driving', 'AMap.Scale', 'AMap.ToolBar', 'AMap.Geocoder', 'AMap.PlaceSearch']
            }).then((AMap) => {
                // åˆ›å»ºåœ°å›¾å®ä¾‹
                map = new AMap.Map('map', {
                    zoom: 10,
                    resizeEnable: true,
                    viewMode: '3D',
                    center: [116.397428, 39.90923] // åŒ—äº¬ä¸­å¿ƒç‚¹
                });
                
                // æ·»åŠ åœ°å›¾æ§ä»¶
                map.addControl(new AMap.ToolBar());
                map.addControl(new AMap.Scale());
                
                // åˆå§‹åŒ–å®šä½æ’ä»¶
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    buttonOffset: new AMap.Pixel(10, 20),
                    zoomToAccuracy: true,
                    buttonPosition: 'RB',
                    showButton: false
                });
                
                map.addControl(geolocation);
                
                // åˆå§‹åŒ–é€†åœ°ç†ç¼–ç æ’ä»¶
                geocoder = new AMap.Geocoder({
                    city: "å…¨å›½", // é»˜è®¤å…¨å›½
                    radius: 1000 // èŒƒå›´åŠå¾„
                });
                
                // åˆå§‹åŒ–åœ°ç‚¹æœç´¢æ’ä»¶
                placeSearch = new AMap.PlaceSearch({
                    city: "å…¨å›½",
                    map: map,
                    panel: null
                });
                
                // åˆå§‹åŒ–è·¯å¾„è§„åˆ’æ’ä»¶
                driving = new AMap.Driving({
                    map: map,
                    policy: AMap.DrivingPolicy.LEAST_TIME,
                    panel: null
                });
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    if (isMapSelectMode) {
                        handleMapClick(e);
                    }
                });
                
                // å°è¯•è·å–å½“å‰ä½ç½®
                // getCurrentLocation();
                hideLoading();
                console.log("åœ°å›¾åˆå§‹åŒ–å®Œæˆ");
            }).catch(e => {
                console.error('åœ°å›¾åŠ è½½å¤±è´¥:', e);
                hideLoading();
                console.log("dwaadwdwadwa")
                alert('åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPI Key');
            });
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶
        function handleMapClick(e) {
            const lnglat = e.lnglat;
            document.getElementById('clickLng').textContent = lnglat.lng.toFixed(6);
            document.getElementById('clickLat').textContent = lnglat.lat.toFixed(6);
            
            // æ˜¾ç¤ºç‚¹å‡»æ ‡è®°
            const marker = document.getElementById('clickMarker');
            marker.style.display = 'block';
            marker.style.left = e.pixel.x + 'px';
            marker.style.top = e.pixel.y + 'px';
            
            // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
            if (clickMarker) {
                clickMarker.setMap(null);   
            }
            
            clickMarker = new AMap.Marker({
                position: [lnglat.lng, lnglat.lat],
                map: map,
                title: 'é€‰æ‹©çš„ä½ç½®',
                content: '<div style="background-color: #e74c3c; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>'
            });
            
            // è¿›è¡Œé€†åœ°ç†ç¼–ç 
            reverseGeocode(lnglat.lng, lnglat.lat, 'click');
        }
        
        // é€†åœ°ç†ç¼–ç ï¼šæ ¹æ®ç»çº¬åº¦è·å–åœ°å€ä¿¡æ¯
        function reverseGeocode(lng, lat, type = 'current') {
            showLoading();
            geocoder.getAddress([lng, lat], function(status, result) {
                hideLoading();
                
                if (status === 'complete' && result.regeocode) {
                    const address = result.regeocode.formattedAddress;
                    const prefix = type === 'click' ? 'click' : 'current';
                    
                    // æ›´æ–°åŸºæœ¬åœ°å€ä¿¡æ¯
                    document.getElementById(`${prefix}Address`).textContent = address;
                    
                    // æ›´æ–°è¯¦ç»†åœ°å€ä¿¡æ¯
                    updateAddressDetails(result.regeocode, prefix);
                    
                    // è·å–é™„è¿‘POIä¿¡æ¯
                    getNearbyPlaces(lng, lat, prefix);
                    
                    // æ›´æ–°åŸå¸‚ä¿¡æ¯
                    const city = getCityFromAddress(result.regeocode);
                    if (city) {
                        currentCity = city;
                        document.getElementById(`${prefix}City`).textContent = city;
                        document.getElementById('citySelect').value = city;
                    }
                    
                    // ä¿å­˜åæ ‡å’Œåœ°å€ä¿¡æ¯
                    if (type === 'click') {
                        // ä¿å­˜åœ°å›¾é€‰ç‚¹çš„åæ ‡å’Œåœ°å€
                        window.currentClickPoint = {
                            lnglat: [lng, lat],
                            address: address
                        };
                    }
                } else {
                    document.getElementById(`${prefix}Address`).textContent = 'åœ°å€è§£æå¤±è´¥';
                    document.getElementById(`${prefix}AddressDetails`).style.display = 'none';
                    document.getElementById(`${prefix}NearbyPOI`).style.display = 'none';
                }
            });
        }
        
        // æ›´æ–°è¯¦ç»†åœ°å€ä¿¡æ¯
        function updateAddressDetails(regeocode, prefix) {
            const addressComponent = regeocode.addressComponent;
            const detailsPanel = document.getElementById(`${prefix}AddressDetails`);
            
            if (addressComponent) {
                document.getElementById(`${prefix}Province`).textContent = addressComponent.province || '-';
                document.getElementById(`${prefix}District`).textContent = addressComponent.district || '-';
                document.getElementById(`${prefix}Township`).textContent = addressComponent.township || '-';
                document.getElementById(`${prefix}Street`).textContent = addressComponent.street || '-';
                document.getElementById(`${prefix}Number`).textContent = addressComponent.number || '-';
                
                detailsPanel.style.display = 'block';
            } else {
                detailsPanel.style.display = 'none';
            }
        }
        
        // ä»åœ°å€ä¿¡æ¯ä¸­æå–åŸå¸‚
        function getCityFromAddress(regeocode) {
            if (regeocode.addressComponent) {
                return regeocode.addressComponent.city || 
                       regeocode.addressComponent.province || 
                       'æœªçŸ¥åŸå¸‚';
            }
            return null;
        }
        
        // è·å–é™„è¿‘ä½ç½®ä¿¡æ¯
        function getNearbyPlaces(lng, lat, prefix) {
            const poiPanel = document.getElementById(`${prefix}NearbyPOI`);
            
            // ä½¿ç”¨é€†åœ°ç†ç¼–ç ç»“æœä¸­çš„POIä¿¡æ¯
            if (window.AMap && geocoder) {
                geocoder.getAddress([lng, lat], function(status, result) {
                    if (status === 'complete' && result.regeocode) {
                        const pois = result.regeocode.pois;
                        if (pois && pois.length > 0) {
                            let poiHtml = '';
                            // æ˜¾ç¤ºå‰5ä¸ªPOI
                            for (let i = 0; i < Math.min(5, pois.length); i++) {
                                const poi = pois[i];
                                poiHtml += `<div class="poi-item" onclick="selectPOI('${poi.name}', '${prefix}')">
                                    <div><strong>${poi.name}</strong></div>
                                    <div>${poi.address || 'æ— åœ°å€ä¿¡æ¯'}</div>
                                    <div>è·ç¦»: ${(poi.distance || 0).toFixed(0)}ç±³</div>
                                </div>`;
                            }
                            poiPanel.innerHTML = poiHtml;
                            poiPanel.style.display = 'block';
                        } else {
                            poiPanel.innerHTML = '<div class="poi-item">æ— é™„è¿‘åœ°ç‚¹ä¿¡æ¯</div>';
                            poiPanel.style.display = 'block';
                        }
                    } else {
                        poiPanel.innerHTML = '<div class="poi-item">è·å–é™„è¿‘åœ°ç‚¹å¤±è´¥</div>';
                        poiPanel.style.display = 'block';
                    }
                });
            }
        }
        
        // é€‰æ‹©POIä½œä¸ºåœ°å€
        function selectPOI(poiName, prefix) {
            const addressInput = prefix === 'click' ? 'endPoint' : 'startPoint';
            document.getElementById(addressInput).value = poiName;
            console.log(`å·²è®¾ç½®${poiName}ä¸º${prefix === 'click' ? 'ç»ˆç‚¹' : 'èµ·ç‚¹'}`);
        }
        
        // è·å–å½“å‰ä½ç½®
        function getCurrentLocation() {
            showLoading();
            geolocation.getCurrentPosition(function(status, result) {
                hideLoading();
                
                if (status === 'complete') {
                    currentPosition = {
                        lng: result.position.lng,
                        lat: result.position.lat,
                        address: result.formattedAddress
                    };
                    
                    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                    document.getElementById('currentLng').textContent = result.position.lng.toFixed(6);
                    document.getElementById('currentLat').textContent = result.position.lat.toFixed(6);
                    document.getElementById('currentAddress').textContent = result.formattedAddress;
                    
                    // å°†å½“å‰ä½ç½®è®¾ç½®ä¸ºèµ·ç‚¹
                    document.getElementById('startPoint').value = result.formattedAddress;
                    
                    // ä¿å­˜å½“å‰ä½ç½®ä¿¡æ¯
                    startPointData.lnglat = [result.position.lng, result.position.lat];
                    startPointData.address = result.formattedAddress;
                    
                    // å°†åœ°å›¾ä¸­å¿ƒè®¾ç½®ä¸ºå½“å‰ä½ç½®
                    map.setCenter([result.position.lng, result.position.lat]);
                    // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
                    new AMap.Marker({
                        position: [result.position.lng, result.position.lat],
                        map: map,
                        title: 'æˆ‘çš„ä½ç½®',
                        content: '<div style="background-color: #4b6cb7; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>'
                    });
                    
                    // è·å–è¯¦ç»†åœ°å€ä¿¡æ¯
                    reverseGeocode(result.position.lng, result.position.lat, 'current');
                    
                } else {
                    console.error('è·å–å½“å‰ä½ç½®å¤±è´¥:', result);
                    document.getElementById('currentAddress').textContent = 'è·å–ä½ç½®å¤±è´¥';
                    document.getElementById('currentAddressDetails').style.display = 'none';
                    document.getElementById('currentNearbyPOI').style.display = 'none';
                    
                    // è®¾ç½®é»˜è®¤èµ·ç‚¹
                    document.getElementById('startPoint').value = "åŒ—äº¬å¸‚æœé˜³åŒº";
                }
            });
        }
        
        // åˆ‡æ¢åœ°å›¾é€‰ç‚¹æ¨¡å¼
        function toggleMapSelectMode() {
            isMapSelectMode = !isMapSelectMode;
            const mapTip = document.getElementById('mapTip');
            const mapSelectBtn = document.getElementById('mapSelect');
            
            if (isMapSelectMode) {
                mapTip.textContent = "åœ°å›¾é€‰ç‚¹æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®";
                mapTip.style.backgroundColor = 'rgba(231, 76, 60, 0.8)';
                mapSelectBtn.innerHTML = '<i>ğŸ—ºğŸ—ºï¸</i> é€€å‡ºé€‰ç‚¹æ¨¡å¼';
                mapSelectBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else {
                mapTip.textContent = "ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®";
                mapTip.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                mapSelectBtn.innerHTML = '<i>ğŸ—ºğŸ—ºï¸</i> åœ°å›¾é€‰ç‚¹';
                mapSelectBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                document.getElementById('clickMarker').style.display = 'none';
            }
        }
        
        // è®¾ç½®é€‰ç‚¹ä¸ºèµ·ç‚¹
        function setClickPointAsStart() {
            if (window.currentClickPoint) {
                const address = window.currentClickPoint.address;
                const lnglat = window.currentClickPoint.lnglat;
                
                document.getElementById('startPoint').value = address;
                startPointData.lnglat = lnglat;
                startPointData.address = address;
                
                // æ·»åŠ èµ·ç‚¹æ ‡è®°
                addStartMarker(lnglat);
                
                console.log("å·²è®¾ç½®ä¸ºèµ·ç‚¹");
            } else {
                console.log("è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©æœ‰æ•ˆä½ç½®");
            }
        }
        
        // è®¾ç½®é€‰ç‚¹ä¸ºç»ˆç‚¹
        function setClickPointAsEnd() {
            if (window.currentClickPoint) {
                const address = window.currentClickPoint.address;
                const lnglat = window.currentClickPoint.lnglat;
                
                document.getElementById('endPoint').value = address;
                endPointData.lnglat = lnglat;
                endPointData.address = address;
                
                // æ·»åŠ ç»ˆç‚¹æ ‡è®°
                addEndMarker(lnglat);
                
                console.log("å·²è®¾ç½®ä¸ºç»ˆç‚¹");
            } else {
                console.log("è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©æœ‰æ•ˆä½ç½®");
            }
        }
        
        // è®¾ç½®å½“å‰ä½ç½®ä¸ºèµ·ç‚¹
        function setCurrentAsStart() {
            const address = document.getElementById('currentAddress').textContent;
            if (address && address !== 'æœªè·å–' && address !== 'è·å–ä½ç½®å¤±è´¥') {
                document.getElementById('startPoint').value = address;
                startPointData.lnglat = [parseFloat(document.getElementById('currentLng').textContent), 
                                        parseFloat(document.getElementById('currentLat').textContent)];
                startPointData.address = address;
                
                // æ·»åŠ èµ·ç‚¹æ ‡è®°
                addStartMarker(startPointData.lnglat);
                
                console.log("å·²è®¾ç½®å½“å‰ä½ç½®ä¸ºèµ·ç‚¹");
            } else {
                console.log("è¯·å…ˆè·å–å½“å‰ä½ç½®");
            }
        }
        
        // è®¾ç½®å½“å‰ä½ç½®ä¸ºç»ˆç‚¹
        function setCurrentAsEnd() {
            const address = document.getElementById('currentAddress').textContent;
            if (address && address !== 'æœªè·å–' && address !== 'è·å–ä½ç½®å¤±è´¥') {
                document.getElementById('endPoint').value = address;
                endPointData.lnglat = [parseFloat(document.getElementById('currentLng').textContent), 
                                      parseFloat(document.getElementById('currentLat').textContent)];
                endPointData.address = address;
                
                // æ·»åŠ ç»ˆç‚¹æ ‡è®°
                addEndMarker(endPointData.lnglat);
                
                console.log("å·²è®¾ç½®å½“å‰ä½ç½®ä¸ºç»ˆç‚¹");
            } else {
                console.log("è¯·å…ˆè·å–å½“å‰ä½ç½®");
            }
        }
        
        // æ–°å¢ï¼šæ·»åŠ èµ·ç‚¹æ ‡è®°
        function addStartMarker(lnglat) {
            if (startMarker) {
                startMarker.setMap(null);
            }
            
            startMarker = new AMap.Marker({
                position: lnglat,
                map: map,
                title: 'èµ·ç‚¹',
                content: '<div style="background-color: #28a745; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>'
            });
        }
        
        // æ–°å¢ï¼šæ·»åŠ ç»ˆç‚¹æ ‡è®°
        function addEndMarker(lnglat) {
            if (endMarker) {
                endMarker.setMap(null);
            }
            
            endMarker = new AMap.Marker({
                position: lnglat,
                map: map,
                title: 'ç»ˆç‚¹',
                content: '<div style="background-color: #e74c3c; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>'
            });
        }
        
        // è·¯å¾„è§„åˆ’
        function routePlan() {
            const startPoint = document.getElementById('startPoint').value;
            const endPoint = document.getElementById('endPoint').value;
            const city = document.getElementById('citySelect').value;
            
            if (!startPoint || !endPoint) {
                alert('è¯·è¾“å…¥èµ·ç‚¹å’Œç»ˆç‚¹');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç²¾ç¡®åæ ‡
            if (!startPointData.lnglat || !endPointData.lnglat) {
                alert('è¯·å…ˆé€šè¿‡åœ°å›¾é€‰ç‚¹æˆ–è·å–å½“å‰ä½ç½®æ¥è®¾ç½®ç²¾ç¡®çš„èµ·ç‚¹å’Œç»ˆç‚¹åæ ‡');
                return;
            }
            
            showLoading();
            
            // æ¸…é™¤ä¹‹å‰çš„è·¯å¾„
            driving.clear();
            document.getElementById('routePanel').innerHTML = 'è®¡ç®—ä¸­...';
            
            console.log("å¼€å§‹è·¯å¾„è§„åˆ’ï¼Œä½¿ç”¨ç²¾ç¡®åæ ‡:");
            console.log("èµ·ç‚¹åæ ‡:", startPointData.lnglat);
            console.log("ç»ˆç‚¹åæ ‡:", endPointData.lnglat);
            console.log("èµ·ç‚¹åœ°å€:", startPointData.address);
            console.log("ç»ˆç‚¹åœ°å€:", endPointData.address);
            
            // ä½¿ç”¨ç²¾ç¡®åæ ‡è¿›è¡Œè·¯å¾„è§„åˆ’
            driving.search(startPointData.lnglat, endPointData.lnglat, function(status, result) {
                console.log("è·¯å¾„è§„åˆ’çŠ¶æ€:", status);
                console.log("è·¯å¾„è§„åˆ’ç»“æœ:", result);
                
                hideLoading();
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (status === 'complete') {
                    document.getElementById('routeInstructions').textContent = 'è·¯å¾„è§„åˆ’æˆåŠŸ';
                    
                    if (result.routes && result.routes.length > 0) {
                        const route = result.routes[0];
                        
                        // æ›´æ–°è·¯å¾„ä¿¡æ¯
                        document.getElementById('routeDistance').textContent = (route.distance / 1000).toFixed(1) + 'å…¬é‡Œ';
                        document.getElementById('routeTime').textContent = Math.ceil(route.time / 60) + 'åˆ†é’Ÿ';
                        
                        // æ˜¾ç¤ºè¯¦ç»†è·¯å¾„
                        let routeHtml = '<div style="font-weight: bold; margin-bottom: 10px;">è·¯çº¿è¯¦æƒ…:</div>';
                        routeHtml += `<div style="margin-bottom: 10px; padding: 5px; background: #e8f4fd; border-radius: 4px;">
                            <div><strong>èµ·ç‚¹:</strong> ${startPointData.address}</div>
                            <div><strong>ç»ˆç‚¹:</strong> ${endPointData.address}</div>
                        </div>`;
                        
                        if (route.steps && route.steps.length > 0) {
                            route.steps.forEach((step, index) => {
                                routeHtml += `<div class="result-item">${index+1}. ${step.instruction} (${(step.distance/1000).toFixed(1)}å…¬é‡Œ)</div>`;
                            });
                        } else {
                            routeHtml += '<div class="result-item">æš‚æ— è¯¦ç»†è·¯çº¿ä¿¡æ¯</div>';
                        }
                        document.getElementById('routePanel').innerHTML = routeHtml;
                    } else {
                        document.getElementById('routeInstructions').textContent = 'æœªæ‰¾åˆ°å¯è¡Œè·¯çº¿';
                        document.getElementById('routePanel').innerHTML = 'æœªæ‰¾åˆ°ä»èµ·ç‚¹åˆ°ç»ˆç‚¹çš„å¯è¡Œè·¯çº¿';
                    }
                } else if (status === 'no_data') {
                    document.getElementById('routeInstructions').textContent = 'æŸ¥è¯¢æ— ç»“æœ';
                    document.getElementById('routePanel').innerHTML = 'æœªæ‰¾åˆ°ç›¸å…³è·¯å¾„ä¿¡æ¯';
                } else {
                    document.getElementById('routeInstructions').textContent = 'æŸ¥è¯¢é”™è¯¯';
                    
                    let errorMsg = "è·¯å¾„è§„åˆ’å¤±è´¥";
                    if (result && result.info) {
                        errorMsg += ": " + result.info;
                    }
                    
                    document.getElementById('routePanel').innerHTML = errorMsg;
                    alert(errorMsg);
                }
            });
        }
        
        // æ¸…é™¤è·¯çº¿
        function clearRoute() {
            if (driving) {
                driving.clear();
            }
            
            // æ¸…é™¤èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
            if (startMarker) {
                startMarker.setMap(null);
                startMarker = null;
            }
            if (endMarker) {
                endMarker.setMap(null);
                endMarker = null;
            }
            
            // é‡ç½®èµ·ç‚¹å’Œç»ˆç‚¹æ•°æ®
            startPointData.lnglat = null;
            startPointData.address = null;
            endPointData.lnglat = null;
            endPointData.address = null;
            
            document.getElementById('routeDistance').textContent = '-';
            document.getElementById('routeTime').textContent = '-';
            document.getElementById('routeInstructions').textContent = '-';
            document.getElementById('routePanel').innerHTML = 'è·¯çº¿è¯¦æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åœ°å›¾...");
            initMap();
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('getLocation').addEventListener('click', getCurrentLocation);
            document.getElementById('routePlan').addEventListener('click', routePlan);
            document.getElementById('clearRoute').addEventListener('click', clearRoute);
            document.getElementById('mapSelect').addEventListener('click', toggleMapSelectMode);
            document.getElementById('setAsStart').addEventListener('click', setClickPointAsStart);
            document.getElementById('setAsEnd').addEventListener('click', setClickPointAsEnd);
            document.getElementById('setAsStart_now').addEventListener('click', setCurrentAsStart);
            document.getElementById('setAsEnd_now').addEventListener('click', setCurrentAsEnd);
            
            // æ·»åŠ å›è½¦é”®è§¦å‘è·¯å¾„è§„åˆ’
            document.getElementById('endPoint').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    routePlan();
                }
            });
            
            // åŸå¸‚é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('citySelect').addEventListener('change', function() {
                currentCity = this.value;
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ ¹æ®åŸå¸‚åˆ‡æ¢åœ°å›¾ä¸­å¿ƒç‚¹çš„é€»è¾‘
            });
        };
    </script>
</body>
</html>